name: PR Validation

on:
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && github.event.pull_request.user.login != 'dependabot[bot]'

    steps:
      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  validate-pr-description:
    name: Validate PR Description
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false && github.event.pull_request.user.login != 'dependabot[bot]'

    steps:
      - name: Check PR description
        uses: actions/github-script@v8
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const minLength = 50;

            if (prBody.trim().length < minLength) {
              core.setFailed(
                `PR description is too short (${prBody.trim().length} chars). ` +
                `Please provide a meaningful description (minimum ${minLength} chars).`
              );
              return;
            }

            const hasWhat = /###?\s*What/i.test(prBody);
            const hasWhy = /###?\s*Why/i.test(prBody);

            if (!hasWhat || !hasWhy) {
              core.setFailed(
                'PR description is missing required sections. ' +
                'Please use the PR template and fill in: What, Why, and Testing sections.'
              );
              return;
            }

            core.info('‚úÖ PR description looks good!');

  check-pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check PR size
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;

            const hardLimit = 1500;
            const softLimit = 400;

            if (totalChanges > hardLimit) {
              core.setFailed(
                `‚ö†Ô∏è  PR is too large (${totalChanges} lines changed). ` +
                `Please consider breaking it into smaller PRs (< ${hardLimit} lines).`
              );
              return;
            }

            if (totalChanges > softLimit) {
              core.warning(
                `‚ö†Ô∏è  PR is getting large (${totalChanges} lines changed). ` +
                `Consider breaking it into smaller PRs for easier review.`
              );
            } else {
              core.info(`‚úÖ PR size is good (${totalChanges} lines changed)`);
            }

  lint-check:
    name: Lint Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore

      - name: Get changed C# files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.event.pull_request.base.ref }}...HEAD | grep '\.cs$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_cs_files=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No C# files changed in this PR"
          else
            echo "has_cs_files=true" >> $GITHUB_OUTPUT
            FILES_SPACE_SEPARATED=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_SPACE_SEPARATED" >> $GITHUB_OUTPUT
            echo "üìù Changed C# files:"
            echo "$CHANGED_FILES"
          fi

      - name: Format check changed files
        if: steps.changed-files.outputs.has_cs_files == 'true'
        run: |
          FILES="${{ steps.changed-files.outputs.files }}"
          echo "üîç Checking formatting for changed files..."
          dotnet format --verify-no-changes --include $FILES --verbosity diagnostic

      - name: Skip format check
        if: steps.changed-files.outputs.has_cs_files == 'false'
        run: echo "‚úÖ No C# files to check - skipping format validation"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore

      - name: Check for vulnerable packages
        run: |
          echo "üîç Scanning for vulnerable packages..."
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt

          if grep -qi "critical\|high" vulnerability-report.txt; then
            echo "‚ùå Critical or High severity vulnerabilities detected!"
            exit 1
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi

  check-todos:
    name: Check TODOs
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for untracked TODOs
        run: |
          untracked=$(grep -rn "TODO\|FIXME" --include="*.cs" --exclude-dir=obj --exclude-dir=bin . | grep -v "#[0-9]" || true)

          if [ ! -z "$untracked" ]; then
            echo "‚ö†Ô∏è  Found TODO/FIXME comments without issue references:"
            echo "$untracked"
            echo ""
            echo "Please either:"
            echo "1. Create an issue and reference it (e.g., // TODO #123: description)"
            echo "2. Fix the item in this PR"
            echo "3. Remove the comment if not needed"
          else
            echo "‚úÖ No untracked TODOs found"
          fi

  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [validate-pr-title, validate-pr-description, check-pr-size, lint-check, security-scan, check-todos]

    steps:
      - name: Check if automated PR
        id: check-automated
        run: |
          if [ "${{ github.event.pull_request.user.login }}" = "dependabot[bot]" ]; then
            echo "automated=true" >> $GITHUB_OUTPUT
          else
            echo "automated=false" >> $GITHUB_OUTPUT
          fi

      - name: All checks passed
        run: |
          if [ "${{ steps.check-automated.outputs.automated }}" = "true" ]; then
            echo "ü§ñ Automated PR validation summary"
            echo "‚úÖ All automated checks passed"
          else
            echo "üéâ All PR validation checks passed!"
            echo "‚úÖ PR title follows Conventional Commits"
            echo "‚úÖ PR has adequate description"
            echo "‚úÖ PR size is reasonable"
            echo "‚úÖ Code formatting is correct"
            echo "‚úÖ No security vulnerabilities"
            echo "‚úÖ No untracked TODOs"
          fi
